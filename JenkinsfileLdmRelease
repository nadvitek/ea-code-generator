node('maven') {

    stage('Clone') {
        checkout(scm).each { k, v -> env.setProperty(k, v) }
        sh 'chmod +x ./sh/*.sh';
    }

  	stage('Generate Swagger') {
		cmn_maven.build()
		withCredentials([usernamePassword(
				credentialsId: 'ea-generator-db-login',
				passwordVariable: 'dbPass',
				usernameVariable: 'dbUser')]) {
			sh 'bash ./sh/run_app.sh'
		}
		dir('export'){
			archiveArtifacts artifacts: 'swagger.yaml', fingerprint: true
			archiveArtifacts artifacts: 'java-config.yaml', fingerprint: true
			archiveArtifacts artifacts: 'pom.xml', fingerprint: true
			archiveArtifacts artifacts: 'git_push.sh', fingerprint: true
		}
	}

    stage('Generate Java') {
        sh 'bash ./sh/generate_java.sh'
        sh 'bash ./sh/fix_java_ldm.sh'
        sh 'rm -rf output_java.zip'
        sh 'zip -r output_java.zip output_java'
        archiveArtifacts artifacts: 'output_java.zip', fingerprint: true
    }

    stage('Build Java') {
        dir('output_java') {
            cmn_maven.build()
        }
    }

    stage('Push Swagger') {
		sshagent(credentials: ['jenkins-gitlab-access-ssh']) {
			sh './sh/clone_or_pull_openapi.sh'
			dir('openapi') {
				sh 'pwd'
				sh 'git config --global user.email "gitlab-technicaluser@cez.cz"'
				sh 'git config --global user.name "technicaluser"'
				sh '../export/git_push.sh'
			}
		}
	}

	stage('Build & Publish Java') {
		dir('output_java') {
			cmn_maven.build(publish:true)
		}
	}
}
